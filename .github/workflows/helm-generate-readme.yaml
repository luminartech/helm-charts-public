# Ref: https://github.com/bitnami/charts/blob/main/.github/workflows/generate-chart-readme.yml
name: '[HELM] Update README'
on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - edited
      - reopened
      - ready_for_review
    paths:
      - 'charts/**/values.yaml'
permissions:
  contents: write
  pull-requests: read
jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Install readme-generator-for-helm
        run: npm install -g @bitnami/readme-generator-for-helm@2.4.3
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          fetch-depth: 0
          persist-credentials: true
          path: luminartech/helm-charts-public
      - name: Get list of changed directories
        id: changed-files
        uses: tj-actions/changed-files@v35
        with:
          dir_names: "true"
          path: luminartech/helm-charts-public
          files: |
            charts/**
      - name: Execute readme-generator-for-helm
        run: |
          set -x
          cd luminartech/helm-charts-public
          # Adding || true to avoid "Process exited with code 1" errors
          charts_dirs_changed="$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep -e '^.\/charts\/iac\/.*/' | cut -d'/' -f 1-3 | uniq || true)"
          charts_dirs_changed+="$(echo -e "\n${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep -e '^.\/charts\/shared\/.*/' | cut -d'/' -f 1-3 | uniq || true)"
          charts_dirs_changed+="$(echo -e "\n${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep -e '^.\/charts\/modules\/apps\/.*/' | cut -d'/' -f 1-4 | uniq || true)"
          charts_dirs_changed+="$(echo -e "\n${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | grep -e '^.\/charts\/modules\/iac\/.*/' | cut -d'/' -f 1-4 | uniq || true)"
          echo $charts_dirs_changed
          for chart in $charts_dirs_changed; do
            echo "Updating README.md for ${chart}"
            if [ -f "${chart}/values.yaml" ]; then
              echo readme-generator --values "${chart}/values.yaml" --readme "${chart}/README.md" --schema "/tmp/schema.json"
            fi
          done
      - name: Push changes to PR branch
        run: |
          # Push all the changes
          cd luminartech/helm-charts-public
          if git status -s | grep charts; then
            git config user.name "CI Bot"
            git config user.email "sre@luminartech.com"
            git add . && git commit -am "Update README.md with readme-generator-for-helm" --signoff && git push
          fi
