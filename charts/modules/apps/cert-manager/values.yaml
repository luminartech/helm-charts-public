---
## @section Global parameters
## Global parameters
## These variables are accessible to all dependency helm charts.
##

global:
  ## @param global.chartNameOverride Overrides the chart name.
  ##
  chartNameOverride: ""
  ## @param global.releaseNameOverride Overrides the release name.
  ##
  releaseNameOverride: ""
  ## @param global.tags Define common tags for all IAC and app resources generated by this chart.
  ##
  tags: {}
  ## @param global.labels Define common labels for all IAC and app resources generated by this chart.
  ##
  labels: {}
  ## @param global.annotations Define common annotations for all IAC and app resources generated by this chart.
  ##
  annotations: {}
  ## @param global.awsAccountId Default aws account id for crossplane aws provider resources. Quotes are important, value must be a string.
  ##
  awsAccountId: "0123456789"
  ## @param global.awsRegion Default aws region for crossplane aws provider resources.
  ##
  awsRegion: us-east-2
  ## @param global.eksHash Default EKS cluster hash for relevant crossplane resources such as IAM Role.
  ##
  eksHash: "XXXXX"
  ## @param global.providerConfigRef.name Default crossplane provider all resources generated for crossplane.
  ##
  providerConfigRef:
    name: 'aws-{{ .Values.global.awsAccountId }}'
  ## @param global.logLevel Set log level to 2 for normal mode and 6 for debug mode.
  logLevel: 6
  ## @param global.deploymentName Deployment name for the app.
  deploymentName: cert-manager
  ## @param global.issuerCertManagerRoleName Role name used by issuer's cert-manager to access shared DNS zone.
  ##
  issuerCertManagerRoleName: "tenant-role"
  ## @param global.team Team.
  ##
  team: test
  ## @param global.environment Environment.
  ##
  environment: dev
  ## @param global.dnsZoneAwsAccountId Default allowed record names.
  ##
  dnsZoneAwsAccountId: "0123456789"
  ## @param global.dnsZoneAwsRegion Aws region where zone is hosted.
  ##
  dnsZoneAwsRegion: "us-west-2"
  ## @param global.dnsZoneName Zone name to be managed.
  ##
  dnsZoneName: "example.com"
  ## @param global.letsencryptServer ServerURL used by Letsencrypt.
  ##
  letsencryptServer: "https://acme-v02.api.letsencrypt.org/directory"
  ## @param global.letsencryptAdminEmail Admin email used by Letsencrypt.
  ##
  letsencryptAdminEmail: "test@example.com"
  ## @param global.deploymentType Type of deployment, either app, issuer or anything else.
  ## app - cert-manager depoloyment in issuer AWS account. Should be single per EKS cluster.
  ## issuer - deploy everything that is necessary in the issuer (DNS zone user) AWS account except cert-manager itself
  ##          and cross-account access role/policy in the AWS account that hosts DNS zone.
  ## anything else - freestyle deployment
  ## See diagram in docs folder.
  deploymentType: "app"

## @section cert-manager configurations
##
## @skip cert-manager
cert-manager:
  enabled: false
  fullnameOverride: cert-manager
  ingressShim:
    defaultIssuerName: default-cluster-issuer
    defaultIssuerKind: ClusterIssuer
  # NOTE: Use below extra args to reset ambient IAM creds usage when cert manager IAM role policy changes happen.
  # Trick is to enable extraargs, make sure cert manager pod restarts with new change and then disable it again
  # Note that cert manager do not work with the extraargs below, it is used only for resetting the ambient IAM creds
  # extraArgs:
  # - --cluster-issuer-ambient-credentials=false
  # We have to keep these settings in here because
  # boolean value is not supported in template fields
  installCRDs: true
  replicaCount: 1
  containerSecurityContext:
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
  prometheus:
    enabled: false
    servicemonitor:
      enabled: false
      labels:
        release: monitoring

## @section Certificate configurations
##
## @skip Certificate
Certificate:
  enabled: false

## @section CertificateRequest configurations
##
## @skip CertificateRequest
CertificateRequest:
  enabled: false

## @section ClusterIssuer configurations
##
## @skip ClusterIssuer
ClusterIssuer:
  items:
    issuer:
      enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
      name: '{{ .Values.global.dnsZoneName | replace "." "-" }}'
      spec:
        acme:
          # The ACME server URL
          server: '{{ .Values.global.letsencryptServer }}'
          # Email address used for ACME registration
          email: '{{ .Values.global.letsencryptAdminEmail }}'
          privateKeySecretRef:
            name: '{{ .Values.global.team }}-{{ .Values.global.environment }}-{{ .Values.global.dnsZoneName | replace "." "-" }}-pkc'
          solvers:
          - selector:
              dnsZones:
              - '{{ .Values.global.dnsZoneName }}'
            dns01:
              route53:
                region: '{{ .Values.global.dnsZoneAwsRegion }}'
                role: 'arn:aws:iam::{{ .Values.global.dnsZoneAwsAccountId }}:role/{{ include "common-gitops.names.release" . }}-xrole'

## @section Issuer configurations
##
## @skip Issuer
Issuer:
  enabled: false

## @section external-dns basic configuration
##
## @skip external-dns
external-dns:
  enabled: false
  resources:
    limits:
      memory: "256Mi"
      cpu: "200m"
    requests:
      memory: "64Mi"
      cpu: "50m"

## @section AWS IAM configurations
##
## @skip crossplane-aws-iam
crossplane-aws-iam:
  Policy:
    items:
      _:
        enabled: '{{ eq .Values.global.deploymentType "app" }}'
        forProvider:
          description: "IAM Policy for cert-manager"
          policy:
            Statement:
              allowAssumeRole:
                Effect: Allow
                Action: sts:AssumeRole
                # We would like to provide as least privileges as possible
                # Since there's usually single cert-manager deployment per cluster but multiple ClusterIssuers
                # with separate roles, we need to grant access to all of them. There's no known way to do it here, os it has to be done at applicationSet level
                Resource:
                  - 'arn:aws:iam::{{ .Values.global.dnsZoneAwsAccountId }}:role/{{ include "common-gitops.names.release" . }}-xrole'
      xrole:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        providerConfigRef:
          name: 'aws-{{ .Values.global.dnsZoneAwsAccountId }}'
        forProvider:
          description: "IAM Policy to access r53 hostedzones"
          policy:
            Statement:
              allowR53getChange:
                Effect: Allow
                Action: route53:GetChange
                Resource: arn:aws:route53:::change/*
              allowRecordSets:
                Effect: Allow
                Action: "route53:ChangeResourceRecordSets"
                Resource: "arn:aws:route53:::hostedzone/*"
                Condition:
                  "ForAllValues:StringLike":
                    "route53:ChangeResourceRecordSetsNormalizedRecordNames":
                      - '*.{{ .Values.global.dnsZoneName }}'
              allowR53ListHostedZones:
                Effect: Allow
                Action:
                  - "route53:ListHostedZones"
                  - "route53:ListHostedZonesByName"
                  - "route53:ListResourceRecordSets"
                Resource: '*'
      issuer:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        forProvider:
          description: "IAM Policy external-dns to manage cross-account Route53 zone"
          policy:
            Statement:
              allowAssumeRoleInR53Account:
                Effect: "Allow"
                Action: "sts:AssumeRole"
                Resource: 'arn:aws:iam::{{ .Values.global.dnsZoneAwsAccountId }}:role/{{ include "common-gitops.names.release" . }}-xrole'
  Role:
    items:
      _:
        enabled: '{{ eq .Values.global.deploymentType "app" }}'
        forProvider:
          assumeRolePolicy:
            Statement:
              allowAssumeRoleWebIdentity:
                Effect: Allow
                Action: sts:AssumeRoleWithWebIdentity
                Principal:
                  Federated: 'arn:aws:iam::{{ .Values.global.awsAccountId }}:oidc-provider/oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}'
                Condition:
                  StringEquals:
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:sub': 'system:serviceaccount:{{ .Release.Namespace }}:{{ .Values.global.deploymentName }}'
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:aud': 'sts.amazonaws.com'
              allowEC2AssumeRole:
                Effect: Allow
                Principal:
                  Service: ec2.amazonaws.com
                Action: sts:AssumeRole
              allowSelfAssumeRole:
                Effect: Allow
                Principal:
                  AWS: '*'
                Action: sts:AssumeRole
                Condition:
                  ArnLike:
                    "aws:PrincipalArn": 'arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ include "common-gitops.names.release" . }}'
      xrole:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        providerConfigRef:
          name: 'aws-{{ .Values.global.dnsZoneAwsAccountId }}'
        forProvider:
          assumeRolePolicy:
            Statement:
              allowAssume:
                Effect: Allow
                Principal:
                  AWS:
                    # Role used by external-dns deployed in issuer's AWS account
                    - 'arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ include "common-gitops.names.release" . }}-issuer'
                    # Role used by cert-manager
                    - 'arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ .Values.global.issuerCertManagerRoleName }}'
                Action: sts:AssumeRole
      issuer:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        forProvider:
          assumeRolePolicy:
            Statement:
              allowAssumeRoleWebIdentity:
                Effect: Allow
                Action: sts:AssumeRoleWithWebIdentity
                Principal:
                  Federated: 'arn:aws:iam::{{ .Values.global.awsAccountId }}:oidc-provider/oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}'
                Condition:
                  StringEquals:
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:sub': 'system:serviceaccount:{{ .Release.Namespace }}:external-dns-{{ .Values.global.dnsZoneName | replace "." "-" }}'
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:aud': 'sts.amazonaws.com'
              allowEC2AssumeRole:
                Effect: Allow
                Principal:
                  Service: ec2.amazonaws.com
                Action: sts:AssumeRole
              allowSelfAssumeRole:
                Effect: Allow
                Principal:
                  AWS: '*'
                Action: sts:AssumeRole
                Condition:
                  ArnLike:
                    "aws:PrincipalArn": 'arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ include "common-gitops.names.release" . }}-issuer'
  RolePolicyAttachment:
    items:
      _:
        enabled: '{{ eq .Values.global.deploymentType "app" }}'
        forProvider:
          policyArnRef:
            name: '{{ include "common-gitops.names.release" . }}'
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}'
      xrole:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        providerConfigRef:
          name: 'aws-{{ .Values.global.dnsZoneAwsAccountId }}'
        forProvider:
          policyArnRef:
            name: '{{ include "common-gitops.names.release" . }}-xrole'
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-xrole'
      issuer:
        enabled: '{{ eq .Values.global.deploymentType "issuer" }}'
        forProvider:
          policyArnRef:
            name: '{{ include "common-gitops.names.release" . }}-issuer'
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-issuer'
