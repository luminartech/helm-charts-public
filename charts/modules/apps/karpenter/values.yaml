---
---
## @section Global parameters
## Global parameters
## These variables are accessible to all dependency helm charts.
##

global:
  ## @param global.chartNameOverride Overrides the chart name.
  ##
  chartNameOverride: ""
  ## @param global.releaseNameOverride Overrides the release name.
  ##
  releaseNameOverride: ""
  ## @param global.tags Define common tags for all IAC and app resources generated by this chart.
  ##
  tags: {}
  ## @param global.labels Define common labels for all IAC and app resources generated by this chart.
  ##
  labels: {}
  ## @param global.annotations Define common annotations for all IAC and app resources generated by this chart.
  ##
  annotations: {}
  ## @param global.providerConfigRef.name Default crossplane provider all resources generated for crossplane.
  ##
  providerConfigRef:
    name: crossplane-provider-config-aws
  ## @param global.awsAccountId Default aws account id for crossplane aws provider resources. Quotes are important, value must be a string.
  ##
  awsAccountId: "0123456789"
  ## @param global.awsRegion Default aws region for crossplane aws provider resources.
  ##
  awsRegion: us-west-2
  ## @param global.vpcFullname VPC to use for this EKS cluster
  ##
  vpcFullname: infra-aws-vpc
  ## @param global.eksHash Default EKS cluster hash for relevant crossplane resources such as IAM Role.
  ##
  eksHash: "XXXXX"
  ## @param global.secretStoreNamespace (Deprecated) Deploy external-secret store configs to different namespace than helm chart target namespace.
  ##
  secretStoreNamespace: infra-argo-cd
  ## @param global.eksClusterName EKS Cluster name
  ##
  eksClusterName: infra-aws-eks
  ## @param global.deploymentName Deployment name used as fullnameoverride for upstream chart.
  ##
  deploymentName: external-secrets

## @skip crossplane-aws-iam
crossplane-aws-iam:
  enabled: false
  Policy:
    items:
      _:
        forProvider:
          description: "IAM Policy for karpenter to access aws services"
          policy:
            Statement:
              allowEC2Karpenteradmin:
                Action:
                  - ec2:CreateFleet
                  - ec2:CreateLaunchTemplate
                  - ec2:CreateTags
                  - ec2:DeleteLaunchTemplate
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeImages
                  - ec2:DescribeInstances
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstanceTypeOfferings
                  - ec2:DescribeInstanceTypes
                  - ec2:DescribeLaunchTemplates
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSpotPriceHistory
                  - ec2:DescribeSubnets
                  - ec2:RequestSpotInstances
                  - ec2:RunInstances
                  - pricing:GetProducts
                  - ssm:GetParameter
                Effect: Allow
                Resource: '*'
              allowIAMPassRole:
                Effect: Allow
                Action: iam:PassRole
                Condition:
                  StringEquals:
                    iam:PassedToService: ec2.amazonaws.com
                Resource: '*'
              allowallowAssumeRoleWebIdentity:
                Effect: Allow
                Action: sts:AssumeRoleWithWebIdentity
                Resource: '*'
              allowConditionalEC2Terminate:
                Effect: Allow
                Action: ec2:TerminateInstances
                Condition:
                  StringLike:
                    ec2:ResourceTag/karpenter.sh/provisioner-name: '*'
                Resource: '*'
              allowElasticLBRegisterInstances:
                Effect: Allow
                Action: elasticloadbalancing:RegisterInstancesWithLoadBalancer
                Resource: arn:aws:elasticloadbalancing:*:*:loadbalancer/*
              allowElasticLBRegisterTargets:
                Effect: Allow
                Action: elasticloadbalancing:RegisterTargets
                Resource: arn:aws:elasticloadbalancing:*:*:*/*
              allowEKSDiscovery:
                Effect: Allow
                Action: eks:DescribeCluster
                Resource: arn:aws:eks:{{ .Values.global.awsRegion }}:{{ .Values.global.awsAccountId }}:cluster/{{ .Values.global.eksClusterName }}
  Role:
    items:
      node:
        forProvider:
          assumeRolePolicy:
            Statement:
              allowEC2AssumeRole:
                Effect: Allow
                Principal:
                  Service: ec2.amazonaws.com
                Action: sts:AssumeRole

      _:
        forProvider:
          description: "IAM Role for karpenter"
          assumeRolePolicy:
            Statement:
              allowAssumeRoleWebIdentity:
                Effect: Allow
                Action: sts:AssumeRoleWithWebIdentity
                Principal:
                  Federated: arn:aws:iam::{{ .Values.global.awsAccountId }}:oidc-provider/oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}
                Condition:
                  StringEquals:
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:sub': 'system:serviceaccount:{{ .Release.Namespace }}:{{ .Values.global.deploymentName }}'
                    'oidc.eks.{{ .Values.global.awsRegion }}.amazonaws.com/id/{{ .Values.global.eksHash }}:aud': 'sts.amazonaws.com'
              allowEC2AssumeRole:
                Effect: Allow
                Principal:
                  Service: ec2.amazonaws.com
                Action: sts:AssumeRole
              allowspotfleetAssumeRole:
                Effect: Allow
                Principal:
                  Service: spotfleet.amazonaws.com
                Action: sts:AssumeRole
              allowSelfAssumeRole:
                Effect: Allow
                Principal:
                  AWS: '*'
                Action: sts:AssumeRole
                Condition:
                  ArnLike:
                    "aws:PrincipalArn": 'arn:aws:iam::{{ .Values.global.awsAccountId }}:role/{{ include "common-gitops.names.release" . }}'

  InstanceProfile:
    items:
      node:
        forProvider:
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'

  RolePolicyAttachment:
    items:
      _:
        forProvider:
          policyArnRef:
            name: '{{ include "common-gitops.names.release" . }}'
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}'
      eks-cni:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
      ebs-csi:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
      eks-worker-node:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
      ecr-read:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
      ssm-managed-core-inst:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
      # Why this is needed? https://karpenter.sh/v0.16.1/getting-started/getting-started-with-eksctl/cloudformation.yaml does not have it
      eks-vpc-res-cont:
        forProvider:
          policyArn: "arn:aws:iam::aws:policy/AmazonEKSVPCResourceController"
          roleRef:
            name: '{{ include "common-gitops.names.release" . }}-node'
    # # TODO: Limit access to ECR
    #   ecr-full-access:
    #     forProvider:
    #       policyArn: "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess"
    #       roleRef:
    #         name: '{{ include "common-gitops.names.release" . }}-node'

## @skip crossplane-aws-ec2
##
crossplane-aws-ec2:
  enabled: false

## @skip karpenter
##
karpenter:
  enabled: false
  fullnameOverride: karpenter
  serviceMonitor:
    enabled: false
    additionalLabels:
      release: monitoring
  # Upstream helm chart does not set resources, but we need it since karpenter also runs on karpenter nodes.
  # Values are based on usage in CICD prod
  controller:
    resources:
      requests:
        cpu: 0.25
        memory: 512Mi
      limits:
        cpu: 0.5
        memory: 1Gi

## @skip Provisioner
##
Provisioner:
  enabled: false
  items:
    _:
      providerRef: # AWSNodeTemplate
        name: '{{ include "common-gitops.names.release" . }}'
      # requirements:
      #   # Zone is taken from subnets anyway
      #   # - key: "topology.kubernetes.io/zone"
      #   #   operator: In
      #   #   values: ["us-west-2a", "us-west-2c", "us-west-2b"]
      #   - key: "karpenter.sh/capacity-type"
      #     operator: In
      #     values: ["spot"]
      #   - key: "node.kubernetes.io/instance-type"
      #     operator: In
      #     values: ["g4dn.4xlarge"]
      #   - key: "kubernetes.io/arch"
      #     operator: In
      #     values: ["amd64"]
      #   - key: kubernetes.io/os
      #     operator: In
      #     values:	["linux"]
      # taints:
      #   - key: "class"
      #     value: "set me"
      #     effect: NoSchedule
      limits:
        resources:
          cpu: 1k
          # memory: 1000Gi
      ttlSecondsAfterEmpty: 30
      ttlSecondsUntilExpired: 7200 # 2 hours

## @skip AWSNodeTemplate
##
AWSNodeTemplate:
  enabled: false
  items:
    _:
      # TODO: Change this to AL2 by default
      amiFamily: Bottlerocket
      instanceProfile: '{{ .Values.global.eksClusterName }}-karpenter-node'
      subnetSelector:
        Name: "{{ .Values.global.vpcFullname }}-private-*"
      securityGroupSelector:
        Name: "eks-cluster-sg-{{ .Values.global.eksClusterName }}-*"
      blockDeviceMappings:
        # Note: Some special instances types may use xvdb as its root device
        #       Most of the generic instance types and AMI images make use of xvda
        #       Bottlerocket uses xvdb as its root device
        - deviceName: /dev/xvdb
          ebs:
            volumeSize: 500Gi
            volumeType: gp3
            iops: 5000
            # encrypted: true
            # kmsKeyID: "arn:aws:kms:us-west-2:111122223333:key/1234abcd-12ab-34cd-56ef-1234567890ab"
            deleteOnTermination: true
            throughput: 500
            # snapshotID: snap-0123456789
      # userData:  |
      #   [settings.bootstrap-containers.setup-ephemeral-disks]
      #     source = "satishweb/bottlerocket-ephemeral-disk-setup:1.46.5-alpine"
      #     mode = "always"
      #     essential = true
      #     # This will format and mount ephemeral disk at /data
