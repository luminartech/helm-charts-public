---
## @section Global parameters
## Global parameters
## These variables are accessible to all dependency helm charts.
##

global:
  ## @param global.chartNameOverride Overrides the chart name.
  ##
  chartNameOverride: ""
  ## @param global.releaseNameOverride Overrides the release name.
  ##
  releaseNameOverride: ""
  ## @param global.tags Define common tags for all IAC and app resources generated by this chart.
  ##
  tags: {}
  ## @param global.labels Define common labels for all IAC and app resources generated by this chart.
  ##
  labels: {}
  ## @param global.annotations Define common annotations for all IAC and app resources generated by this chart.
  ##
  annotations: {}
  ## @param global.environment Application environment
  ##
  environment: 'dev'
  ## @param global.IAMRoleARN Default IAM role ARN for pod
  ##
  IAMRoleARN: "arn:aws:iam::AWS-ACCOUNT-ID:role/IAM-ROLE-NAME"
  ## @param global.persistentDataDiskSize Persistent volume size for the pod
  ##
  persistentDataDiskSize: 10Gi
  ## @param global.storageClassName Persistent volume claim class
  ##
  storageClassName: "default"
  ## @param global.dockerEnabled Enable docker in docker
  ##
  dockerEnabled: "false"
  images:
    ## @param global.images.devcontainer Devcontainer image
    ##
    devcontainer: "satishweb/devops-tools:latest"
  env:
    ## @param global.env.FIXUID Fix UID for the persistent volume mount
    ##
    FIXUID: 1000
    ## @param global.env.FIXGID Fix GID for the persistent volume mount
    ##
    FIXGID: 1000
    ## @param global.env.HOME Default home directory path for the container
    ##
    HOME: "/persistent-data"
    ## @param global.env.SOURCE_DIR devspace sources dir
    ##
    SOURCE_DIR: "sources"
    ## @param global.env.OPENAI_API_KEY OpenAI API Key
    ##
    OPENAI_API_KEY: ""
    ## @param global.env.OPENAI_MAX_TOKENS OpenAI max tokens
    ##
    OPENAI_MAX_TOKENS: "1000"
    ## @param global.env.OPENAI_MODEL OpenAI model
    ##
    OPENAI_MODEL: "gpt-3.5-turbo"
    ## @param global.env.OPENAI_PROXY OpenAI proxy
    ##
    OPENAI_PROXY: ""
    ## @param global.env.OPENAI_TEMPERATURE OpenAI temperature
    ##
    OPENAI_TEMPERATURE: "0.2"
    ## @param global.env.USER_DEFAULT_PROMPT_MODE Default prompt mode
    ##
    USER_DEFAULT_PROMPT_MODE: "exec"
    ## @param global.env.USER_PREFERENCES User preferences
    ##
    USER_PREFERENCES: "Never execute any commands without my confirmation!"
  ## Resources for containers
  resources:
    # Init container resources
    initContainer:
      requests:
        ## @param global.resources.initContainer.requests.cpu CPU requests
        ##
        cpu: "1"
        ## @param global.resources.initContainer.requests.memory Memory requests
        ##
        memory: "512Mi"
      limits:
        ## @param global.resources.initContainer.limits.cpu CPU limits
        ##
        cpu: "1"
        ## @param global.resources.initContainer.limits.memory Memory limits
        ##
        memory: "512Mi"
    ## Devspace container resources
    devspace:
      requests:
        ## @param global.resources.devspace.requests.cpu CPU requests
        ##
        cpu: "4"
        ## @param global.resources.devspace.requests.memory Memory requests
        ##
        memory: "4Gi"
      limits:
        ## @param global.resources.devspace.limits.cpu CPU limits
        ##
        cpu: "4"
        ## @param global.resources.devspace.limits.memory Memory limits
        ##
        memory: "4Gi"
    ## Devspace container resources
    dind:
      requests:
        ## @param global.resources.dind.requests.cpu CPU requests
        ##
        cpu: "4"
        ## @param global.resources.dind.requests.memory Memory requests
        ##
        memory: "4Gi"
      limits:
        ## @param global.resources.dind.limits.cpu CPU limits
        ##
        cpu: "4"
        ## @param global.resources.dind.limits.memory Memory limits
        ##
        memory: "4Gi"

## @section Devspace configurations
##

common-res:
  ## @param common-res.enabled Toggle for enabling or disabling chatbot ui resources.
  ##
  enabled: true
  StatefulSet:
    items:
      _:
        ## @param common-res.StatefulSet.items._.replicas Number of desired pods. Disable this if HPA is enabled
        ##
        replicas: 0
        ## @param common-res.StatefulSet.items._.revisionHistoryLimit ReplicaSet revision history limit
        ##
        revisionHistoryLimit: 3
        ## @param common-res.StatefulSet.items._.selector Additional selectors for the deployment
        ##
        selector: {}
        ## @skip common-res.StatefulSet.items._.labels
        ##
        # labels:
        #   app.kubernetes.io/instance: "{{ .Release.Name }}"

        ## Pod spec template (to generate spec.template)
        ##
        podSpec:
          spec:
            ## @param common-res.StatefulSet.items._.podSpec.spec.automountServiceAccountToken Automount Service account token
            ##
            automountServiceAccountToken: false
            ## @param common-res.StatefulSet.items._.podSpec.spec.restartPolicy Restart policy for the pod
            restartPolicy: Always
            ## Configure the Security Context for the Pod
            securityContext:
              ## WARNING: Changing user id will not allow sudo to work properly.
              ##          you could add new user with your custom uid and then switch to that user using sudo command
              ## @param common-res.StatefulSet.items._.podSpec.spec.securityContext.runAsGroup Specify the default user group id
              ##
              runAsGroup: 1000
              ## @param common-res.StatefulSet.items._.podSpec.spec.securityContext.runAsUser Specify the default user id
              ##
              runAsUser: 1000
              ## @param common-res.StatefulSet.items._.podSpec.spec.securityContext.fsGroup Specify the default fs group id
              ##
              fsGroup: 1000
              ## @param common-res.StatefulSet.items._.podSpec.spec.securityContext.supplementalGroups Specify the additional groups
              ##
              supplementalGroups: []
              ## @param common-res.StatefulSet.items._.podSpec.spec.securityContext.fsGroupChangePolicy Specify the default gs group change policy
              ##
              fsGroupChangePolicy: OnRootMismatch
            ## Init Containers configuration
            ## @skip common-res.StatefulSet.items._.podSpec.spec.initContainers
            ##
            initContainers:
              - name: init
                image: '{{ .Values.global.images.devcontainer }}'
                command:
                  - /bin/bash
                  # - -exc
                  - -ec
                  - |
                    dest_dir={{ .Values.global.env.HOME }}
                    if [ ! -f "$dest_dir/.devspace.keep" ]; then
                      mkdir -p "$dest_dir/${SOURCE_DIR}"
                      touch "$dest_dir/.devspace.keep"
                      chown -Rf ${FIXUID}:${FIXGID} "$dest_dir"
                    fi
                    devspace_dir=/.devspace
                    mkdir -p "${devspace_dir}"
                    chown -Rf ${FIXUID}:${FIXGID} "${devspace_dir}"
                    sudo -u ${USER} HOME="${HOME}" /bin/bash -e /entrypoint.sh
                securityContext:
                  runAsUser: 0  # Run as root user to setup disks
                  allowPrivilegeEscalation: true  # Allow privilege escalation if necessary
                env:  # Add environment variables here
                  - name: HOME
                    value: "{{ .Values.global.env.HOME }}"
                  - name: SOURCE_DIR
                    value: "{{ .Values.global.env.SOURCE_DIR }}"
                  - name: USER
                    value: "ubuntu"
                  - name: FIXUID
                    value: "{{ .Values.global.env.FIXUID }}"
                  - name: FIXGID
                    value: "{{ .Values.global.env.FIXGID }}"
                  - name: OPENAI_API_KEY
                    value: "{{ .Values.global.env.OPENAI_API_KEY }}"
                  - name: OPENAI_MAX_TOKENS
                    value: "{{ .Values.global.env.OPENAI_MAX_TOKENS }}"
                  - name: OPENAI_MODEL
                    value: "{{ .Values.global.env.OPENAI_MODEL }}"
                  - name: OPENAI_PROXY
                    value: "{{ .Values.global.env.OPENAI_PROXY }}"
                  - name: OPENAI_TEMPERATURE
                    value: "{{ .Values.global.env.OPENAI_TEMPERATURE }}"
                  - name: USER_DEFAULT_PROMPT_MODE
                    value: "{{ .Values.global.env.USER_DEFAULT_PROMPT_MODE }}"
                  - name: USER_PREFERENCES
                    value: "{{ .Values.global.env.USER_PREFERENCES }}"
                volumeMounts:
                  - mountPath: "{{ .Values.global.env.HOME }}"
                    name: '{{ include "common-gitops.names.release" . }}'
                    readOnly: false
                  - name: devspace
                    mountPath: /.devspace
                    readOnly: false
                ## Set the resource requests / limits for the main container.
                ##
                resources:
                  requests:
                    cpu: "{{ .Values.global.resources.initContainer.requests.cpu }}"
                    memory: "{{ .Values.global.resources.initContainer.requests.memory }}"
                  limits:
                    cpu: "{{ .Values.global.resources.initContainer.limits.cpu }}"
                    memory: "{{ .Values.global.resources.initContainer.limits.memory }}"
            ## Containers configuration
            ##
            containers:
              ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].name
              ##
              - name: devspace
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].image
                ##
                image: '{{ .Values.global.images.devcontainer }}'
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].imagePullPolicy Container image pullPolicy. Allowed values: `IfNotPresent`, `Always`, `Never`
                ##
                imagePullPolicy: IfNotPresent
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].tty Determines whether containers in a pod runs with TTY enabled.
                ##
                tty: true
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].stdin Determines whether containers in a pod runs with stdin enabled.
                ##
                stdin: true
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[0].command
                ##
                command: ["/bin/sh", "-ec", "sudo chown root:${FIXGID} /certs/client && tail -f /dev/null"]
                ## Container ports configuration
                ##
                ports:
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].ports[0].name Name of the port
                  ##
                  - name: http
                    ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].ports[0].containerPort The port number
                    ##
                    containerPort: 8080

                    ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].ports[0].protocol Port protocol. Allowed values: "SCTP", `TCP` and `UDP`.
                    ##
                    protocol: TCP
                ## Default Volume mounts
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[0].volumeMounts
                ##
                volumeMounts:
                  - name: devshm
                    mountPath: /dev/shm
                    readOnly: false
                  - mountPath: "{{ .Values.global.env.HOME }}"
                    name: '{{ include "common-gitops.names.release" . }}'
                    readOnly: false
                  - name: tmp
                    mountPath: /tmp
                    readOnly: false
                  - name: certs
                    mountPath: /certs
                    readOnly: false
                  - name: devspace
                    mountPath: /.devspace
                    readOnly: false
                  - name: varrun
                    mountPath: /var/run
                    readOnly: false
                ## Environment variables configuration
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[0].env
                ##
                env:  # Add environment variables here
                  - name: HOME
                    value: "{{ .Values.global.env.HOME }}"
                  - name: SOURCE_DIR
                    value: "{{ .Values.global.env.SOURCE_DIR }}"
                  - name: USER
                    value: "ubuntu"
                  - name: FIXUID
                    value: "{{ .Values.global.env.FIXUID }}"
                  - name: FIXGID
                    value: "{{ .Values.global.env.FIXGID }}"
                  - name: NAMESPACE
                    value: "{{ .Release.Namespace }}"
                  - name: OPENAI_API_KEY
                    value: "{{ .Values.global.env.OPENAI_API_KEY }}"
                  - name: OPENAI_MAX_TOKENS
                    value: "{{ .Values.global.env.OPENAI_MAX_TOKENS }}"
                  - name: OPENAI_MODEL
                    value: "{{ .Values.global.env.OPENAI_MODEL }}"
                  - name: OPENAI_PROXY
                    value: "{{ .Values.global.env.OPENAI_PROXY }}"
                  - name: OPENAI_TEMPERATURE
                    value: "{{ .Values.global.env.OPENAI_TEMPERATURE }}"
                  - name: USER_DEFAULT_PROMPT_MODE
                    value: "{{ .Values.global.env.USER_DEFAULT_PROMPT_MODE }}"
                  - name: USER_PREFERENCES
                    value: "{{ .Values.global.env.USER_PREFERENCES }}"
                  - name: DOCKER_HOST
                    value: "tcp://localhost:2376"
                  - name: DOCKER_TLS_VERIFY
                    value: "1"
                  - name: DOCKER_CERT_PATH
                    value: "/certs/client"
                ## Set the resource requests / limits for the main container.
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[0].resources
                ##
                resources:
                  requests:
                    cpu: "{{ .Values.global.resources.devspace.requests.cpu }}"
                    memory: "{{ .Values.global.resources.devspace.requests.memory }}"
                  limits:
                    cpu: "{{ .Values.global.resources.devspace.limits.cpu }}"
                    memory: "{{ .Values.global.resources.devspace.limits.memory }}"
                ## Security context configuration
                ##
                securityContext:
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.privileged Privileged mode true or false. Allowed values: `true` or `false`
                  ##
                  privileged: false
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.readOnlyRootFilesystem Access level for the file system.  Allowed values: `true` or `false`
                  ##
                  readOnlyRootFilesystem: false
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.allowPrivilegeEscalation Allow escalation of privileges true or false. Allowed values: `true` or `false`
                  ##
                  allowPrivilegeEscalation: true
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.runAsNonRoot Run the process as root, true or false. Allowed values: `true` or `false`
                  ##
                  runAsNonRoot: true
                  seccompProfile:
                    ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.seccompProfile.type Seccomp profile type
                    ##
                    type: RuntimeDefault
                  ## Linux pod capabilities configurations
                  ## https://man7.org/linux/man-pages/man7/capabilities.7.html
                  ##
                  # capabilities:
                  #   ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.capabilities.drop Capabilities to drop
                  #   ##
                  #   drop:
                  #     - ALL
                  #   ## @param common-res.StatefulSet.items._.podSpec.spec.containers[0].securityContext.capabilities.add Capabilities to add
                  #   ##
                  #   add:
                  #     - SYS_ADMIN
                  #     - CAP_CHOWN
                  #     - CAP_KILL
                  #     - CAP_MKNOD
                  #     - CAP_PERFMON
                  #     - CAP_SETGID
                  #     - CAP_SETPCAP
              ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].name
              ##
              - name: dind
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].image
                ##
                image: 'docker:dind-rootless@sha256:a5090d7c11c05a862ae22fbb478c62a4e9643fa431eaf7a9a7812fef7a67a859'
                ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].imagePullPolicy Container image pullPolicy. Allowed values: `IfNotPresent`, `Always`, `Never`
                ##
                imagePullPolicy: IfNotPresent
                ## Container ports configuration
                ##
                ports:
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].ports[0].name Name of the port
                  ##
                  - name: docker
                    ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].ports[0].containerPort The port number
                    ##
                    containerPort: 2376

                    ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].ports[0].protocol Port protocol. Allowed values: "SCTP", `TCP` and `UDP`.
                    ##
                    protocol: TCP
                ## Default Volume mounts
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[1].volumeMounts
                ##
                volumeMounts:
                  - name: devshm
                    mountPath: /dev/shm
                    readOnly: false
                  - mountPath: "/var/lib/docker"
                    name: '{{ include "common-gitops.names.release" . }}'
                    subPath: docker-data
                    readOnly: false
                  - name: tmp
                    mountPath: /tmp
                    readOnly: false
                  - name: certs
                    mountPath: /certs
                    readOnly: false
                  - name: varrun
                    mountPath: /var/run
                    readOnly: false
                ## @skip common-res.StatefulSet.items._.podSpec.spec.containers[1].resources
                resources:
                  requests:
                    cpu: "{{ .Values.global.resources.dind.requests.cpu }}"
                    memory: "{{ .Values.global.resources.dind.requests.memory }}"
                  limits:
                    cpu: "{{ .Values.global.resources.dind.limits.cpu }}"
                    memory: "{{ .Values.global.resources.dind.limits.memory }}"
                ## Security context configuration
                ##
                securityContext:
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].securityContext.runAsGroup Specify the default user group id
                  ##
                  runAsGroup: 0
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].securityContext.runAsUser Specify the default user id
                  ##
                  runAsUser: 0
                  ## @param common-res.StatefulSet.items._.podSpec.spec.containers[1].securityContext.privileged Privileged mode true or false. Allowed values: `true` or `false`
                  ##
                  privileged: true
            ## Pod Volumes configuration
            ## @skip common-res.StatefulSet.items._.podSpec.spec.volumes
            volumes:
              - name: devshm
                emptyDir:
                  medium: Memory
              - name: varrun
                emptyDir:
                  medium: Memory
              - name: tmp
                emptyDir: {}
              - name: certs
                emptyDir: {}
              - name: devspace
                emptyDir: {}

        ## Storage Volume Claims
        ## @skip common-res.StatefulSet.items._.volumeClaimTemplates
        ##
        ## We are defining template in the sts to avoid helm uninstall command and argocd from deleting it
        volumeClaimTemplates:
          - metadata:
              name: '{{ include "common-gitops.names.release" . }}'
            spec:
              accessModes:
              - ReadWriteOnce
              resources:
                requests:
                  storage: "{{ .Values.global.persistentDataDiskSize }}"
              storageClassName: "{{ .Values.global.storageClassName }}"

  ## Serviceaccount configuration
  ## @default -- See below
  ##
  ServiceAccount:
    ## ServiceAccount configuration for main pod
    ##
    items:
      _:
        ## @param common-res.ServiceAccount.items._.enabled Specifies whether a service account should be created. Allowed values: `true` or `false`
        ##
        enabled: true
        annotations:
          ## @param common-res.ServiceAccount.items._.annotations.eks.amazonaws.com/role-arn The AWS IAM role ARN for service account of the pod
          ##
          eks.amazonaws.com/role-arn: '{{ .Values.global.IAMRoleARN }}'

  ## Kubernetes Role configuration
  ## @default -- See below
  ## @skip common-res.Role
  ##
  Role:
    enabled: true
    items:
      _:
        rules:
          - apiGroups:
            - ""
            resources:
              - pods
              - services
            verbs:
              - get
              - list
              - watch

  ## RoleBinding configuration
  ## @default -- See below
  ## @skip common-res.RoleBinding
  ##
  RoleBinding:
    enabled: true
    items:
      _:
        roleRef:
          apiGroup: rbac.authorization.k8s.io
          kind: Role
          name: '{{ include "common-gitops.names.release" . }}'
        subjects:
          - kind: ServiceAccount
            name: '{{ include "common-gitops.names.release" . }}'
            namespace: '{{ .Release.Namespace }}'

  ## Configure the services for the chart here.
  ## Additional services can be added by adding a dictionary key similar to the 'main' service.
  ## @default -- See below
  Service:
    ## Service configuration for main pod
    ##
    items:
      _:
        ## @param common-res.Service.items._.enabled Enables or disables the service
        ##
        enabled: true
        spec:
          ## @param common-res.Service.items._.spec.selector Additional selectors
          ##
          selector: {}

          ## @param common-res.Service.items._.spec.type Set the service type
          # Options: Simple(Loadbalancer), LoadBalancer, ClusterIP, NodePort
          ##
          type: ClusterIP

          ## @param common-res.Service.items._.spec.ipFamilyPolicy Specify the ip policy. Options: SingleStack, PreferDualStack, RequireDualStack
          ##
          ipFamilyPolicy: SingleStack

          ## Configure the Service port information here.
          ## Additional ports can be added by adding a dictionary key similar to the 'http' service.
          ## @default -- See below
          ##
          ports:
            ## @param common-res.Service.items._.spec.ports[0].name The port number
            ##
            - name: http
              ## @param common-res.Service.items._.spec.ports[0].port The port number
              ##
              port: 8080

              ## @param common-res.Service.items._.spec.ports[0].protocol Port protocol. Allowed values: `TCP`, `SCTP` or `UDP`.
              ##
              protocol: TCP

              ## @param common-res.Service.items._.spec.ports[0].targetPort Specify a service targetPort if you wish to differ the service port from the application port.
              ## If `targetPort` is specified, this port number is used in the container definition instead of
              ## the `port` value. Therefore named ports are not supported for this field.
              ##
              targetPort: 8080
